# Labeling to PDF

비콘(Beacon) 설치 현장 사진을 OCR로 분석하여 Minor 번호별로 자동 분류하고, 전문적인 PDF 보고서를 생성하는 자동화 시스템입니다.

## 프로젝트 개요

이 시스템은 현장에서 촬영한 비콘 설치 사진들을 자동으로 분석하여:
- 이미지에서 Minor 번호를 자동 인식 (OCR)
- Minor 번호별로 사진을 체계적으로 분류
- 분류된 사진들을 전문적인 PDF 보고서로 자동 생성

## 프로젝트 구조

```
labeling-to-pdf/
├── source/                 # 원본 이미지 파일들 (현장 촬영 사진)
├── output/                 # 분류된 이미지 파일들 (Minor 값별 폴더)
│   ├── Minor_0001/        # Minor 0001 비콘 사진들
│   ├── Minor_0002/        # Minor 0002 비콘 사진들
│   ├── ...
│   └── Unknown/           # Minor 값을 찾지 못한 파일들
├── pdf_output/            # 생성된 PDF 보고서
│   └── *.pdf
├── fonts/                 # PDF 생성용 한글 폰트 (Pretendard)
│   ├── Pretendard-Regular.ttf
│   └── Pretendard-Bold.ttf
├── logo.png               # PDF 보고서에 포함될 로고
├── organize_by_minor.py   # 단계 1: 이미지 분류 스크립트
├── recheck_unknown.py     # 단계 1.5: Unknown 폴더 재검사 스크립트
├── create_pdf.py          # 단계 2: PDF 보고서 생성 스크립트
├── analyze_samples.py     # 샘플 이미지 분석 도구
└── README.md
```

## 주요 기능

### ✅ 단계 1: 이미지 자동 분류
- EasyOCR을 사용한 고정밀 텍스트 인식
- 이미지 전처리를 통한 OCR 정확도 향상 (대비 향상, 노이즈 제거, 이진화)
- 파일명 기반 우선 인식 + OCR 보조 인식
- 실시간 진행 상황 모니터링 (진행률, 처리 속도, 예상 시간)
- Minor 번호별 자동 폴더 생성 및 파일 분류

### ✅ 단계 1.5: Unknown 파일 재검사
- Unknown 폴더의 미분류 파일들을 재검사
- 향상된 OCR 파라미터로 재분석
- 파일명 규칙 재검증
- Source와 Output 파일 수 비교 및 완료율 표시
- 자동 이동 및 통계 제공

### ✅ 단계 2: PDF 보고서 자동 생성
- **전문적인 레이아웃**: A4 용지, 2열 배치, 자동 페이지 넘김
- **한글 지원**: Pretendard 폰트 자동 다운로드 및 적용
- **고품질 이미지**: 300 DPI 해상도 유지
- **헤더/푸터**: 시설명, JRIndustry 로고, 페이지 번호
- **Beacon별 구성**: 각 Beacon 번호별로 관련 사진들을 그룹화
- **자동 이미지 배치**: 사진 개수에 따라 최적의 레이아웃 자동 선택
- **둥근 모서리 박스**: 현대적이고 깔끔한 디자인

## 시스템 요구사항

- **Python**: 3.9 이상
- **운영체제**: macOS, Linux, Windows
- **메모리**: 최소 4GB RAM (OCR 처리 시)
- **저장공간**: 약 500MB (라이브러리 및 OCR 모델 포함)

## 설치 방법

### 1. 필수 패키지 설치

```bash
# 핵심 라이브러리 설치
pip3 install easyocr opencv-python reportlab pillow

# 또는 requirements.txt가 있는 경우
pip3 install -r requirements.txt
```

**설치되는 라이브러리:**
- `easyocr`: OCR 텍스트 인식
- `opencv-python`: 이미지 전처리
- `reportlab`: PDF 생성
- `pillow`: 이미지 처리

### 2. EasyOCR 모델 자동 다운로드

처음 실행 시 EasyOCR이 자동으로 한국어 + 영어 모델을 다운로드합니다. (약 200MB)

### 3. Pretendard 폰트 자동 설정

PDF 생성 시 Pretendard 폰트가 자동으로 다운로드되고 설정됩니다. 별도의 설치 작업이 필요 없습니다.

## 사용 방법

### 📋 전체 워크플로우

```
1. source/ 폴더에 원본 사진 넣기
    ↓
2. organize_by_minor.py 실행 (이미지 분류)
    ↓
3. recheck_unknown.py 실행 (미분류 파일 재검사) [선택적]
    ↓
4. create_pdf.py 실행 (PDF 보고서 생성)
    ↓
5. pdf_output/ 폴더에서 완성된 PDF 확인
```

---

### 📁 단계 0: 원본 이미지 준비

1. 현장에서 촬영한 비콘 설치 사진들을 `source/` 폴더에 넣습니다.
2. 지원 형식: `.jpg`, `.jpeg`, `.png`

---

### 🔍 단계 1: 이미지 자동 분류

```bash
python3 organize_by_minor.py
```

**기능:**
- `source/` 폴더의 모든 이미지를 OCR로 분석
- 파일명 또는 이미지 내 텍스트에서 Minor 번호 추출
- Minor 번호별로 `output/Minor_XXXX/` 폴더에 자동 분류
- 인식 실패 시 `output/Unknown/` 폴더에 저장

**실행 예시:**
```
======================================================================
단계 1: 이미지 분류 시작
======================================================================
시작 시간: 2024-11-25 11:00:00

📁 총 205개 이미지 파일을 처리합니다...

[####################                    ] 50% [103/205] 처리 중: 장호원비콘설치1.jpg
  | 경과: 2분 30초 | 예상 남은 시간: 2분 30초
[####################                    ] 50% [103/205] ✓ 장호원비콘설치1.jpg → Minor_0001 (1.2초)
...

======================================================================
단계 1: 이미지 분류 완료
======================================================================
완료 시간: 2024-11-25 11:15:30
총 소요 시간: 15분 30초
평균 처리 속도: 4.54초/파일

📊 처리 결과:
  ✓ 성공: 200개 파일
  ⚠ 실패: 5개 파일

📁 Minor 값별 분류 (93개 폴더):
  Minor_0001: 2개 파일
  Minor_0002: 2개 파일
  Minor_0003: 2개 파일
  ...
```

---

### 🔄 단계 1.5: Unknown 파일 재검사 (선택적)

첫 번째 분류에서 Minor 값을 찾지 못한 파일들을 재검사합니다:

```bash
python3 recheck_unknown.py
```

**기능:**
- `output/Unknown` 폴더의 미분류 이미지를 재검사
- 파일명 규칙 재검증
- Source와 Output 파일 수 비교
- 향상된 OCR 파라미터로 재분석
- 자동 이동 및 통계 제공

**실행 예시:**
```
======================================================================
Output 폴더 재검증 시작
======================================================================
시작 시간: 2024-11-25 11:20:00

📊 파일 수 비교:
  source 폴더: 205개 파일
  output 폴더: 205개 파일
  ✅ 파일 수 일치: 205개 (100%)

======================================================================
Unknown 폴더 OCR 재검사 시작
======================================================================
📁 총 5개 파일을 OCR로 재검사합니다...

[########################################] 100% [5/5] ✓ IMG_9944.png → Minor_0005 (2.1초)

======================================================================
재검증 완료
======================================================================
📊 최종 결과:
  ✓ 파일명 규칙으로 이동: 0개 파일
  ✓ OCR 재검사로 이동: 3개 파일
  ⚠ 여전히 Unknown: 2개 파일
```

---

### 📄 단계 2: PDF 보고서 생성

```bash
python3 create_pdf.py
```

**기능:**
- `output/` 폴더의 분류된 이미지들을 하나의 PDF로 통합
- Beacon 번호 순서로 자동 정렬
- 2열 레이아웃 (공간 효율적 배치)
- 각 Beacon별 사진 개수에 따라 최적 레이아웃 자동 선택
- 고해상도 이미지 유지 (300 DPI)
- 헤더에 시설명, 푸터에 로고 및 페이지 번호

**실행 예시:**
```
======================================================================
PDF 생성 시작 (통합 PDF)
======================================================================
시작 시간: 2024-11-25 11:30:00

✓ Pretendard 폰트 로드 완료

📁 총 93개 Beacon을 하나의 PDF로 통합합니다...

  [1/93] Beacon 1: 2개 이미지 (왼쪽, 페이지 1)... ✓ 완료
  [2/93] Beacon 2: 2개 이미지 (오른쪽, 페이지 1)... ✓ 완료
  [3/93] Beacon 3: 2개 이미지 (왼쪽, 페이지 1)... ✓ 완료
  ...

======================================================================
PDF 생성 완료
======================================================================
완료 시간: 2024-11-25 11:35:00
총 소요 시간: 5분 0초

📊 처리 결과:
  ✓ 성공: 93개 Beacon
  ✗ 실패: 0개 Beacon
  📷 총 이미지: 205개
  📄 총 페이지: 47페이지

📁 출력 파일: /path/to/pdf_output/이천_장호원_하수도_사업소_Beacon_설치현황.pdf
  ✓ 로고 이미지 포함됨
```

---

## 🔧 기술적 세부사항

### Minor 값 추출 알고리즘

시스템은 다음의 우선순위로 Minor 번호를 추출합니다:

**1. 최우선: 파일명 기반 추출 (가장 정확)**
- 파일명에서 우측 날짜 패턴 제거 (예: `251104130`)
- "설치" 다음의 숫자를 Minor로 추출
- 예: `장호원비콘설치10251104130.jpg` → `Minor_0010`
- 예: `장호원비콘설치1251104120.jpg` → `Minor_0001`

**2. 차순위: OCR 텍스트 인식**
- 이미지 내 "Minor" 키워드 옆의 4자리 숫자 추출
- 예: `"Minor: 0019"` → `Minor_0019`
- OCR 오류 자동 보정: `"Minor: OO19"` → `Minor_0019`

**3. 3순위: 설치 텍스트 기반**
- OCR로 "설치" 텍스트 옆의 1~3자리 숫자 추출
- 4자리로 자동 변환
- 예: `"설치: 10"` → `Minor_0010`

### 이미지 전처리 과정

OCR 정확도를 높이기 위한 자동 전처리:
1. 그레이스케일 변환
2. CLAHE 대비 향상
3. 가우시안 블러 노이즈 제거
4. OTSU 이진화
5. 모폴로지 연산으로 텍스트 선명화

### 출력 폴더 구조

```
output/
├── Minor_0001/              # Minor 값 0001 비콘 사진들
│   ├── IMG_9940.png
│   └── 장호원비콘설치1.jpg
├── Minor_0002/              # Minor 값 0002 비콘 사진들
│   ├── IMG_9941.png
│   └── 장호원비콘설치2.jpg
├── ...
├── Minor_0093/              # Minor 값 0093 비콘 사진들
└── Unknown/                 # Minor 값을 찾지 못한 이미지들
    └── (미분류 파일들)
```

### PDF 레이아웃 특징

- **페이지 크기**: A4 (210mm × 297mm)
- **레이아웃**: 2열 배치 (공간 효율 극대화)
- **이미지 해상도**: 300 DPI 고품질 유지
- **자동 배치**: 사진 개수에 따라 최적 레이아웃 선택
  - 1~3개: 가로 배치
  - 4개: 전체 너비 사용
  - 5개 이상: 2열 그리드 배치
- **헤더**: 시설명 + JRIndustry
- **푸터**: 페이지 번호 + 로고 이미지

---

## ⚙️ 설정 사용자화

### PDF 제목 및 시설명 변경

`create_pdf.py` 파일의 상단에서 시설명을 변경할 수 있습니다:

```python
# 41~42번째 줄
FACILITY_NAME = "이천 장호원 하수도 사업소"  # 원하는 시설명으로 변경
PDF_TITLE_TEMPLATE = f"{FACILITY_NAME} 설치된 Beacon"
```

### 로고 이미지 교체

PDF 하단에 표시될 로고를 교체하려면:
1. `logo.png` 파일을 원하는 로고로 교체
2. PNG 형식 권장
3. 권장 크기: 가로 200~400px

---

## ❗ 문제 해결

### OCR 인식 오류가 발생하는 경우

**증상**: 파일이 Unknown 폴더에 많이 들어감

**해결방법**:
1. 파일명에 Minor 번호가 포함되어 있는지 확인
2. 이미지가 너무 흐리거나 어둡지 않은지 확인
3. `recheck_unknown.py`를 실행하여 재검사
4. 필요시 Unknown 폴더의 파일을 수동으로 해당 Minor 폴더로 이동

### 처리 속도가 너무 느린 경우

**예상 시간**: 파일당 약 2~5초 (CPU 성능에 따라 다름)

**해결방법**:
- 첫 실행 시 OCR 모델 다운로드로 인해 시간이 더 걸립니다
- GPU가 있는 경우 EasyOCR GPU 모드로 전환하면 속도 향상
- 프로그레스 바를 통해 예상 남은 시간을 확인할 수 있습니다

### PDF 생성 시 한글이 깨지는 경우

**증상**: PDF에서 한글이 □□□로 표시됨

**해결방법**:
- `create_pdf.py`를 실행하면 Pretendard 폰트가 자동으로 다운로드됩니다
- 폰트 파일이 `fonts/` 폴더에 있는지 확인
- 인터넷 연결이 필요합니다 (폰트 다운로드 시)

### 메모리 부족 오류

**증상**: 이미지 처리 중 메모리 오류 발생

**해결방법**:
- 한 번에 처리하는 이미지 수를 줄입니다
- Source 폴더의 파일을 여러 번에 나눠서 처리
- 이미지 해상도를 줄입니다 (필요한 경우)

---

## 📊 성능 및 통계

**실제 프로젝트 결과**:
- 총 이미지 수: 205개
- 총 Beacon 수: 93개
- 분류 소요 시간: 약 15분 (macOS M1 기준)
- PDF 생성 시간: 약 5분
- PDF 페이지 수: 47페이지
- 최종 PDF 파일 크기: 약 50MB (고해상도 이미지)

---

## 🛠️ 개발 정보

### 기술 스택
- **언어**: Python 3.9+
- **OCR**: EasyOCR (한국어 + 영어)
- **이미지 처리**: OpenCV, Pillow
- **PDF 생성**: ReportLab
- **폰트**: Pretendard (한글 지원)

### 주요 라이브러리
- `easyocr`: 딥러닝 기반 OCR 엔진
- `opencv-python`: 이미지 전처리
- `reportlab`: PDF 문서 생성
- `pillow`: 이미지 파일 처리

### 프로젝트 특징
- 완전 자동화된 워크플로우
- 실시간 진행 상황 모니터링
- 파일명 기반 우선 인식으로 정확도 향상
- 이미지 전처리를 통한 OCR 정확도 개선
- 전문적인 PDF 레이아웃 자동 생성

---

## 📝 라이선스

이 프로젝트는 내부 사용 목적으로 개발되었습니다.

---

## 📧 문의

프로젝트 관련 문의사항이 있으시면 이슈를 등록해주세요.

